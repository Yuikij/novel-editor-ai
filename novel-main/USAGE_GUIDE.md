# RAGå¢å¼ºå†™ä½œç³»ç»Ÿä½¿ç”¨æŒ‡å—

## å¿«é€Ÿå¼€å§‹

### 1. ç³»ç»Ÿé…ç½®

åœ¨ `application.yml` ä¸­é…ç½®ç›¸å…³å‚æ•°ï¼š

```yaml
novel:
  chapter:
    default-max-tokens: 2000      # é»˜è®¤æœ€å¤§tokenæ•°
    default-temperature: 0.7      # é»˜è®¤æ¸©åº¦å‚æ•°
  rag:
    max-results: 5               # RAGæœç´¢æœ€å¤§ç»“æœæ•°
    enabled: true                # æ˜¯å¦å¯ç”¨RAGåŠŸèƒ½
  template:
    chat:
      max-results: 5
      similarity-threshold: 0.0
      max-tokens: 2000
      temperature: 0.7
```

### 2. åŸºæœ¬ä½¿ç”¨æµç¨‹

#### æ­¥éª¤1ï¼šå‡†å¤‡é¡¹ç›®æ•°æ®
ç¡®ä¿ä½ çš„é¡¹ç›®åŒ…å«ä»¥ä¸‹åŸºç¡€æ•°æ®ï¼š
- é¡¹ç›®åŸºæœ¬ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€ç®€ä»‹ã€é£æ ¼ç­‰ï¼‰
- è§’è‰²ä¿¡æ¯ï¼ˆå§“åã€æ€§æ ¼ã€èƒŒæ™¯ç­‰ï¼‰
- æƒ…èŠ‚è®¾å®šï¼ˆç« èŠ‚æƒ…èŠ‚ã€å‘å±•è„‰ç»œç­‰ï¼‰
- ä¸–ç•Œè§‚è®¾å®šï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

#### æ­¥éª¤2ï¼šå‘èµ·ç« èŠ‚å†…å®¹ç”Ÿæˆè¯·æ±‚
```java
ChapterContentRequest request = new ChapterContentRequest();
request.setChapterId(123L);
request.setMaxTokens(2000);
request.setTemperature(0.7f);

// è°ƒç”¨æœåŠ¡
Result<String> result = chapterContentService.generateChapterContentExecute(request);
```

#### æ­¥éª¤3ï¼šç›‘æ§ç”Ÿæˆè¿›åº¦
```java
String planId = result.getData();
PlanContext context = chapterContentService.getPlanContextMap().get(planId);

// æ£€æŸ¥çŠ¶æ€
PlanState state = context.getPlanState();
String message = context.getMessage();
int progress = context.getProgress();
```

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### ğŸ”§ å·¥å…·è°ƒç”¨ç³»ç»Ÿ

#### è§’è‰²æŸ¥è¯¢å·¥å…· (character_query)
```json
{
  "tool": "character_query",
  "parameters": {
    "queryType": "by_project",
    "projectId": 123,
    "characterName": "ä¸»è§’åç§°"  // å¯é€‰
  }
}
```

**æ”¯æŒçš„æŸ¥è¯¢ç±»å‹ï¼š**
- `by_name`: æŒ‰è§’è‰²åç§°æŸ¥è¯¢
- `by_id`: æŒ‰è§’è‰²IDæŸ¥è¯¢  
- `by_project`: æŸ¥è¯¢é¡¹ç›®ä¸‹æ‰€æœ‰è§’è‰²

#### æƒ…èŠ‚æŸ¥è¯¢å·¥å…· (plot_query)
```json
{
  "tool": "plot_query",
  "parameters": {
    "queryType": "by_chapter",
    "chapterId": 456,
    "projectId": 123  // å¯é€‰
  }
}
```

**æ”¯æŒçš„æŸ¥è¯¢ç±»å‹ï¼š**
- `by_title`: æŒ‰æƒ…èŠ‚æ ‡é¢˜æŸ¥è¯¢
- `by_id`: æŒ‰æƒ…èŠ‚IDæŸ¥è¯¢
- `by_chapter`: æŸ¥è¯¢ç« èŠ‚ç›¸å…³æƒ…èŠ‚
- `by_project`: æŸ¥è¯¢é¡¹ç›®ä¸‹æ‰€æœ‰æƒ…èŠ‚

#### RAGæœç´¢å·¥å…· (rag_search)
```json
{
  "tool": "rag_search",
  "parameters": {
    "projectId": 123,
    "query": "ä¸»è§’çš„æ€§æ ¼ç‰¹å¾",
    "maxResults": 5,
    "searchType": "character"
  }
}
```

**æ”¯æŒçš„æœç´¢ç±»å‹ï¼š**
- `general`: é€šç”¨æœç´¢
- `character`: è§’è‰²ç›¸å…³æœç´¢
- `world`: ä¸–ç•Œè§‚ç›¸å…³æœç´¢
- `chapter`: ç« èŠ‚ç›¸å…³æœç´¢

### ğŸ¤– æ™ºèƒ½å†™ä½œæµç¨‹

#### 1. åˆ†æé˜¶æ®µ (Analysis)
ç³»ç»Ÿä¼šåˆ†æå½“å‰çš„å†™ä½œä»»åŠ¡ï¼š
- ç†è§£ç« èŠ‚ä¸Šä¸‹æ–‡
- è¯†åˆ«éœ€è¦çš„ä¿¡æ¯ç±»å‹
- åˆ¶å®šä¿¡æ¯è·å–ç­–ç•¥

#### 2. æŸ¥è¯¢é˜¶æ®µ (Query)
æ ¹æ®åˆ†æç»“æœï¼Œè‡ªåŠ¨è°ƒç”¨ç›¸å…³å·¥å…·ï¼š
- æŸ¥è¯¢æ¶‰åŠçš„è§’è‰²ä¿¡æ¯
- è·å–ç›¸å…³æƒ…èŠ‚è®¾å®š
- æœç´¢èƒŒæ™¯èµ„æ–™

#### 3. è§„åˆ’é˜¶æ®µ (Planning)
åŸºäºè·å–çš„ä¿¡æ¯åˆ¶å®šå†™ä½œè®¡åˆ’ï¼š
- ç¡®å®šå†™ä½œé‡ç‚¹
- å®‰æ’å™äº‹ç»“æ„
- è®¾å®šå­—æ•°ç›®æ ‡

#### 4. åˆ›ä½œé˜¶æ®µ (Creation)
æ‰§è¡Œå…·ä½“çš„å†…å®¹åˆ›ä½œï¼š
- æµå¼ç”Ÿæˆå†…å®¹
- å®æ—¶è´¨é‡ç›‘æ§
- ä¿æŒä¸€è‡´æ€§

## é«˜çº§åŠŸèƒ½

### ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

#### æŸ¥çœ‹å·¥å…·çŠ¶æ€
```java
Map<String, String> toolStates = writingToolManager.getToolStates();
for (Map.Entry<String, String> entry : toolStates.entrySet()) {
    System.out.println(entry.getKey() + ": " + entry.getValue());
}
```

#### è·å–å·¥å…·æè¿°
```java
Map<String, String> descriptions = writingToolManager.getToolDescriptions();
```

#### æ£€æŸ¥å·¥å…·å¯ç”¨æ€§
```java
boolean available = writingToolManager.isToolAvailable("character_query");
```

### ğŸ”„ æµå¼å¤„ç†

#### ç›‘å¬ç”Ÿæˆè¿‡ç¨‹
```java
PlanContext context = chapterContentService.getPlanContextMap().get(planId);
Flux<String> contentStream = context.getPlanStream();

if (contentStream != null) {
    contentStream.subscribe(
        content -> {
            // å¤„ç†ç”Ÿæˆçš„å†…å®¹ç‰‡æ®µ
            System.out.print(content);
        },
        error -> {
            // å¤„ç†é”™è¯¯
            System.err.println("ç”Ÿæˆå¤±è´¥: " + error.getMessage());
        },
        () -> {
            // ç”Ÿæˆå®Œæˆ
            System.out.println("\nç”Ÿæˆå®Œæˆï¼");
        }
    );
}
```

### ğŸ¯ è‡ªå®šä¹‰é…ç½®

#### è°ƒæ•´ç”Ÿæˆå‚æ•°
```java
ChapterContentRequest request = new ChapterContentRequest();
request.setChapterId(123L);
request.setMaxTokens(3000);        // å¢åŠ tokenæ•°é‡
request.setTemperature(0.8f);      // æé«˜åˆ›é€ æ€§
```

#### å¯ç”¨/ç¦ç”¨RAGåŠŸèƒ½
```yaml
novel:
  rag:
    enabled: false  # ç¦ç”¨RAGåŠŸèƒ½
```

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

#### 1. æ•°æ®å‡†å¤‡
- **å®Œå–„è§’è‰²ä¿¡æ¯**ï¼šç¡®ä¿è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€ç›®æ ‡ç­‰ä¿¡æ¯å®Œæ•´
- **è¯¦ç»†æƒ…èŠ‚è®¾å®š**ï¼šä¸ºæ¯ä¸ªç« èŠ‚è®¾ç½®æ¸…æ™°çš„æƒ…èŠ‚ç›®æ ‡
- **ä¸€è‡´çš„ä¸–ç•Œè§‚**ï¼šä¿æŒä¸–ç•Œè§‚è®¾å®šçš„å†…åœ¨é€»è¾‘

#### 2. å‚æ•°è°ƒä¼˜
- **åˆç†è®¾ç½®tokenæ•°**ï¼šæ ¹æ®ç« èŠ‚é•¿åº¦éœ€æ±‚è°ƒæ•´maxTokens
- **é€‚å½“çš„æ¸©åº¦å€¼**ï¼š0.7-0.8é€‚åˆåˆ›æ„å†™ä½œï¼Œ0.3-0.5é€‚åˆäº‹å®æ€§å†…å®¹
- **RAGç»“æœæ•°é‡**ï¼šé€šå¸¸5-10ä¸ªç»“æœè¶³å¤Ÿï¼Œè¿‡å¤šä¼šå½±å“æ€§èƒ½

#### 3. ç›‘æ§å’Œä¼˜åŒ–
- **å®æ—¶ç›‘æ§çŠ¶æ€**ï¼šå…³æ³¨ç”Ÿæˆè¿›åº¦å’Œå·¥å…·è°ƒç”¨æƒ…å†µ
- **åˆ†æå·¥å…·ä½¿ç”¨**ï¼šæŸ¥çœ‹å“ªäº›å·¥å…·è¢«é¢‘ç¹ä½¿ç”¨
- **å†…å®¹è´¨é‡è¯„ä¼°**ï¼šå®šæœŸæ£€æŸ¥ç”Ÿæˆå†…å®¹çš„è´¨é‡

### âŒ é¿å…äº‹é¡¹

#### 1. æ•°æ®é—®é¢˜
- **ä¿¡æ¯ä¸å®Œæ•´**ï¼šè§’è‰²æˆ–æƒ…èŠ‚ä¿¡æ¯ç¼ºå¤±ä¼šå½±å“ç”Ÿæˆè´¨é‡
- **æ•°æ®çŸ›ç›¾**ï¼šç¡®ä¿è§’è‰²è®¾å®šå’Œæƒ…èŠ‚å‘å±•çš„ä¸€è‡´æ€§
- **è¿‡æ—¶ä¿¡æ¯**ï¼šåŠæ—¶æ›´æ–°é¡¹ç›®ç›¸å…³ä¿¡æ¯

#### 2. å‚æ•°è®¾ç½®
- **tokenæ•°è¿‡å¤§**ï¼šå¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜æˆ–å“åº”ç¼“æ…¢
- **æ¸©åº¦å€¼æç«¯**ï¼šè¿‡é«˜(>0.9)å¯èƒ½äº§ç”Ÿä¸è¿è´¯å†…å®¹ï¼Œè¿‡ä½(<0.3)å¯èƒ½è¿‡äºæœºæ¢°
- **é¢‘ç¹è°ƒç”¨**ï¼šé¿å…çŸ­æ—¶é—´å†…é‡å¤ç”Ÿæˆç›¸åŒå†…å®¹

#### 3. ç³»ç»Ÿä½¿ç”¨
- **å¿½ç•¥é”™è¯¯**ï¼šåŠæ—¶å¤„ç†å·¥å…·è°ƒç”¨å¤±è´¥æˆ–ç”Ÿæˆé”™è¯¯
- **èµ„æºæ³„æ¼**ï¼šç¡®ä¿è®¡åˆ’å®Œæˆåæ¸…ç†ç›¸å…³èµ„æº
- **å¹¶å‘å†²çª**ï¼šé¿å…åŒæ—¶ä¸ºåŒä¸€ç« èŠ‚ç”Ÿæˆå¤šä¸ªç‰ˆæœ¬

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å·¥å…·è°ƒç”¨å¤±è´¥
**ç—‡çŠ¶**ï¼šå·¥å…·è¿”å›é”™è¯¯æˆ–ç©ºç»“æœ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- éªŒè¯æŸ¥è¯¢å‚æ•°
- æŸ¥çœ‹å·¥å…·çŠ¶æ€æ—¥å¿—

#### 2. RAGæœç´¢æ— ç»“æœ
**ç—‡çŠ¶**ï¼šæœç´¢è¿”å›ç©ºç»“æœ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å‘é‡åŒ–çŠ¶æ€
- è°ƒæ•´æœç´¢é˜ˆå€¼
- éªŒè¯è¿‡æ»¤æ¡ä»¶

#### 3. ç”Ÿæˆå†…å®¹è´¨é‡å·®
**ç—‡çŠ¶**ï¼šå†…å®¹ä¸è¿è´¯æˆ–åç¦»ä¸»é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®Œå–„åŸºç¡€æ•°æ®
- è°ƒæ•´æ¸©åº¦å‚æ•°
- æ£€æŸ¥æç¤ºè¯è®¾ç½®

#### 4. æ€§èƒ½é—®é¢˜
**ç—‡çŠ¶**ï¼šç”Ÿæˆé€Ÿåº¦æ…¢æˆ–å†…å­˜å ç”¨é«˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°‘tokenæ•°é‡
- é™åˆ¶RAGç»“æœæ•°
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

### æ—¥å¿—åˆ†æ

#### å…³é”®æ—¥å¿—æ ‡è¯†
- `[RAGå¢å¼ºå†™ä½œ]`: ä¸»è¦æµç¨‹æ—¥å¿—
- `è§’è‰²æŸ¥è¯¢å·¥å…·`: è§’è‰²æŸ¥è¯¢ç›¸å…³æ—¥å¿—
- `æƒ…èŠ‚æŸ¥è¯¢å·¥å…·`: æƒ…èŠ‚æŸ¥è¯¢ç›¸å…³æ—¥å¿—
- `RAGæœç´¢å·¥å…·`: RAGæœç´¢ç›¸å…³æ—¥å¿—

#### æ—¥å¿—çº§åˆ«è®¾ç½®
```yaml
logging:
  level:
    com.soukon.novelEditorAi.agent: DEBUG
    com.soukon.novelEditorAi.service.impl.ChapterContentServiceImpl: INFO
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°å·¥å…·

#### 1. å®ç°å·¥å…·æ¥å£
```java
public class CustomTool implements WritingToolCallback {
    @Override
    public WritingToolResult apply(String input, ToolContext toolContext) {
        // å®ç°å·¥å…·é€»è¾‘
        return WritingToolResult.success("ç»“æœ");
    }
    
    // å®ç°å…¶ä»–å¿…è¦æ–¹æ³•...
}
```

#### 2. æ³¨å†Œåˆ°å·¥å…·ç®¡ç†å™¨
```java
@Component
public class WritingToolManager {
    private void initializeTools() {
        // æ·»åŠ è‡ªå®šä¹‰å·¥å…·
        CustomTool customTool = new CustomTool();
        toolInstances.put(customTool.getName(), customTool);
    }
}
```

### è‡ªå®šä¹‰æç¤ºè¯

#### ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯
```java
private String buildEnhancedSystemPrompt() {
    return """
            ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°è¯´åˆ›ä½œAIåŠ©æ‰‹...
            
            ## è‡ªå®šä¹‰è§„åˆ™
            1. ç‰¹æ®Šè¦æ±‚1
            2. ç‰¹æ®Šè¦æ±‚2
            """;
}
```

## æ€»ç»“

RAGå¢å¼ºå†™ä½œç³»ç»Ÿé€šè¿‡æ™ºèƒ½å·¥å…·è°ƒç”¨å’Œä¿¡æ¯æ£€ç´¢ï¼Œæ˜¾è‘—æå‡äº†AIå†™ä½œçš„è´¨é‡å’Œæ™ºèƒ½åŒ–ç¨‹åº¦ã€‚æ­£ç¡®ä½¿ç”¨æœ¬ç³»ç»Ÿå¯ä»¥å¸®åŠ©ä½ ï¼š

- ğŸ¯ **æé«˜å†™ä½œè´¨é‡**ï¼šåŸºäºå‡†ç¡®ä¿¡æ¯è¿›è¡Œåˆ›ä½œ
- ğŸ”„ **ä¿æŒå†…å®¹ä¸€è‡´æ€§**ï¼šé¿å…è§’è‰²å’Œæƒ…èŠ‚çŸ›ç›¾
- âš¡ **æå‡åˆ›ä½œæ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–ä¿¡æ¯è·å–å’Œåˆ†æ
- ğŸ¨ **å¢å¼ºæ–‡å­¦æ€§**ï¼šä¸“ä¸šçš„æ–‡å­¦åˆ›ä½œæŒ‡å¯¼

éµå¾ªæœ¬æŒ‡å—çš„æœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿå……åˆ†å‘æŒ¥ç³»ç»Ÿçš„æ½œåŠ›ï¼Œåˆ›ä½œå‡ºé«˜è´¨é‡çš„å°è¯´å†…å®¹ã€‚ 