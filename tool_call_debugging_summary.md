# LLM工具调用问题诊断与修复总结

## 问题现象
用户反馈：在单元测试中LLM能正常调用工具，但在实际项目应用（计划生成阶段）中，LLM不调用工具。

## 问题根本原因分析

### 1. 系统提示词结构问题
**原问题：** 系统提示词末尾有强制性的JSON输出指令：
```
直接输出结构化json格式，不需要额外的任何解释说明！
```

**影响：** 这个强制性指令让LLM认为应该立即输出JSON，跳过工具调用步骤。

**修复：** 改为：
```
## 输出要求
**重要：** 在使用工具获取信息并完成分析后，输出结构化json格式。
```

### 2. 用户提示词内容缺失
**原问题：** 用户为了测试简化，注释了extracted()方法中的所有内容，导致返回空字符串。

**影响：** 实际发送给LLM的上下文信息几乎为空，缺乏足够的信息支撑工具调用决策。

**修复：** 添加基本的测试内容：
```java
userPromptBuilder.append("## 测试用的基本信息\n");
userPromptBuilder.append("- 这是一个测试场景\n");
userPromptBuilder.append("- 请先使用工具获取真实内容\n");
userPromptBuilder.append("- 然后基于工具结果制定计划\n\n");
```

### 3. 参数精度问题
**原问题：** 章节ID使用%d格式化，可能导致LLM在处理长数字时出现精度误差。

**修复：** 改为字符串格式：
```java
// 从：调用latest_content_get工具获取最新内容（章节ID: %d, 字数: 1000, 计划ID: %s）
// 改为：调用latest_content_get工具获取最新内容（章节ID: "%s", 字数: 1000, 计划ID: "%s"）
```

### 4. 提示词流程优化
**原问题：** JSON输出要求过于突出，工具调用指示不够强烈。

**修复：** 
- 将提示词分为三个清晰的步骤
- 第一步强调"必须使用工具获取信息"
- 第三步才是"输出格式"要求

## 修复后的提示词结构

### 系统提示词（关键修改）
```java
你是一位资深的文学编辑和创作导师，拥有丰富的小说创作和指导经验。你有access to tools，必须优先使用工具获取信息。

**关键行为原则：**
- 在制定计划前，必须使用latest_content_get工具获取最新内容
- 严格按照用户提供的参数调用工具
- 不要编造或假设内容，而是通过工具获取真实信息

...（其他创作指导）...

## 输出要求
**重要：** 在使用工具获取信息并完成分析后，输出结构化json格式。
```

### 用户提示词（关键修改）
```java
## 第一步：必须使用工具获取信息
在制定计划前，请立即执行以下步骤：
1. 调用latest_content_get工具获取最新内容（章节ID: "xxx", 字数: 1000, 计划ID: "xxx"）
2. 基于工具返回的真实内容进行后续分析

## 第二步：基于工具结果制定写作计划
获取工具信息后，请根据以下上下文信息和工具获取的内容，分析并创作符合要求的写作计划：

[上下文信息]

## 第三步：输出格式
完成工具调用和分析后，直接输出结构化json格式，不需要额外的任何解释说明！
```

## 修复的核心文件

1. **PromptServiceImpl.java**
   - buildReasoningPrompt()方法
   - extracted()方法（添加测试内容）
   - 系统提示词优化
   - 参数格式化修复

2. **ToolService.java** （之前已修复）
   - 参数类型从Long改为String
   - 增加安全检查和详细日志

## 预期效果

修复后的系统应该能够：
1. ✅ 在计划生成阶段正确调用latest_content_get工具
2. ✅ 正确传递章节ID和计划ID参数（字符串格式）
3. ✅ 基于工具返回的真实内容制定写作计划
4. ✅ 按正确顺序执行：工具调用 → 分析 → JSON输出

## 验证建议

1. 查看日志中的"[Reasoning] 最终推理提示词"输出
2. 查看ToolService中的工具调用日志
3. 确认LLM先调用工具，再输出JSON格式的计划

## 技术洞察

1. **LLM工具调用的敏感性**：强制性的输出指令会严重干扰工具调用行为
2. **提示词结构的重要性**：工具调用指示必须在输出格式要求之前
3. **参数类型一致性**：使用字符串格式传递ID可以避免精度问题
4. **上下文信息的必要性**：即使在测试中，也需要提供基本的上下文信息 